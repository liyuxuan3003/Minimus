\ProvidesPackage{minimus-section}

% -------------------------------- %
% Load package <etoolbox> : Toolbox for class and package
\RequirePackage{etoolbox}
% Load package <xparse> : New way to define command and environment
\RequirePackage{xparse}

% -------------------------------- %
% Load package <apptools> : Macro about appendix (\IfAppendix)
\RequirePackage{apptools}

% -------------------------------- %
% Add auto label and bookmark only short title to section commands

% \section*[short-title]{full-title;label}!
% #1 *                   -> no number
% #2 [short-title]       -> title for toc,header,bookmark (default=full-title)
% #3 {full-title;label}  -> title for text ; label (default=full-title) 
% #4 !                   -> short-title usage
% |---- If false         -> short-title will be use in bookmark only
% |---- If true          -> short-title will be use in toc,header,bookmark

% \@ifclassloaded        -> All of these command can not work with beamer
% \ifdef                 -> In case of \chapter undefined in article

\NewDocumentCommand{\split@two}{mm}%
{%
    % \xa -> title
    \def\xa{#1}%
    % \xb -> label
    \IfValueTF{#2}{\def\xb{#2}}{\def\xb{#1}}%
}%

% Label of \part
\@ifclassloaded{beamer}{}{\ifdef{\part}%
{%
    \NewCommandCopy\partold\part%
    \RenewDocumentCommand{\part}{so>{\SplitArgument{1}{;}}mt!}%
    {%
        \split@two#3%
        \IfBooleanTF{#1}%
        {%
            % Without number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\partold*[#2]{\xa}}%
                {\partold*{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \partold*{\xa}%
            }%
        }%
        {%
            % With number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\partold[#2]{\xa}}%
                {\partold{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \partold{\xa}%
            }%
            \ifdefempty{\xb}{}{\label{part:\xb}}%
        }%
    }%
}{}}%

% Label of \chapter
\@ifclassloaded{beamer}{}{\ifdef{\chapter}%
{%
    \NewCommandCopy\chapterold\chapter
    \RenewDocumentCommand{\chapter}{so>{\SplitArgument{1}{;}}mt!}%
    {%
        \split@two#3%
        \IfBooleanTF{#1}%
        {%
            % Without number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\chapterold*[#2]{\xa}}%
                {\chapterold*{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \chapterold*{\xa}%
            }%
        }%
        {%
            % With number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\chapterold[#2]{\xa}}%
                {\chapterold{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \chapterold{\xa}%
            }%
            % Special treatment for chapter / appendix
            \ifdefempty{\xb}{}{\IfAppendix{\label{ap:\xb}}{\label{chap:\xb}}}%
        }%
    }%
}{}}%


% Label of \section
\@ifclassloaded{beamer}{}{\ifdef{\section}%
{%
    \NewCommandCopy\sectionold\section%
    \RenewDocumentCommand{\section}{so>{\SplitArgument{1}{;}}mt!}%
    {%
        \split@two#3
        \IfBooleanTF{#1}%
        {%
            % Without number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\sectionold*[#2]{\xa}}%
                {\sectionold*{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \sectionold*{\xa}%
            }%
        }%
        {%
            % With number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\sectionold[#2]{\xa}}%
                {\sectionold{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \sectionold{\xa}%
            }%
            \ifdefempty{\xb}{}{\label{sec:\xb}}%
        }%
    }%
}{}}%

% Label of \subsection
\@ifclassloaded{beamer}{}{\ifdef{\subsection}%
{%
    \NewCommandCopy\subsectionold\subsection%
    \RenewDocumentCommand{\subsection}{so>{\SplitArgument{1}{;}}mt!}%
    {%
        \split@two#3%
        \IfBooleanTF{#1}%
        {%
            % Without number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\subsectionold*[#2]{\xa}}%
                {\subsectionold*{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \subsectionold*{\xa}%
            }%
        }%
        {%
            % With number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\subsectionold[#2]{\xa}}%
                {\subsectionold{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \subsectionold{\xa}%
            }%
            \ifdefempty{\xb}{}{\label{subsec:\xb}}%
        }%
    }%
}{}}%

% Label of \subsubsection
\@ifclassloaded{beamer}{}{\ifdef{\subsubsection}%
{%
    \NewCommandCopy\subsubsectionold\subsubsection%
    \RenewDocumentCommand{\subsubsection}{so>{\SplitArgument{1}{;}}mt!}%
    {%
        \split@two#3%
        \IfBooleanTF{#1}%
        {%
            % Without number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\subsubsectionold*[#2]{\xa}}%
                {\subsubsectionold*{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \subsubsectionold*{\xa}%
            }%
        }%
        {%
            % With number
            \IfValueTF{#2}%
            {%
                \IfBooleanTF{#4}%
                {\subsubsectionold[#2]{\xa}}%
                {\subsubsectionold{\texorpdfstring{\xa}{#2}}}%
            }%
            {%
                \subsubsectionold{\xa}%
            }%
            \ifdefempty{\xb}{}{\label{subsubsec:\xb}}%
        }%
    }%
}{}}%